<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RoomExpense Pro — Final</title>
<style>
  :root{
    --bg:#f6f8f8; --card:#ffffff; --text:#1f2d2b; --muted:#6b7773;
    --primary:#147a43; --accent:#89c08a; --danger:#d63f3f; --shadow:rgba(13,40,26,0.06);
  }
  *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text)}
  .app{max-width:1100px;margin:0 auto;padding:12px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;border-radius:10px;background:var(--card);box-shadow:0 6px 18px var(--shadow);position:sticky;top:10px;z-index:30}
  .title{display:flex;align-items:center;gap:10px}
  h1{margin:0;font-size:20px;color:var(--primary)}
  .small{font-size:13px;color:var(--muted)}
  .nav-actions{display:flex;align-items:center;gap:8px}
  .icon-btn{width:40px;height:40px;border-radius:10px;background:transparent;border:1px solid #e6efe6;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .icon-btn.active{box-shadow:0 0 0 4px rgba(20,122,67,0.12);border-color:var(--primary);background:linear-gradient(90deg, rgba(20,122,67,0.06), transparent)}
  .menu{display:flex;gap:8px;margin-top:12px}
  .menu-item{padding:8px 12px;border-radius:8px;background:transparent;color:var(--muted);border:1px solid transparent;cursor:pointer;font-weight:600}
  .menu-item.active{background:var(--primary);color:#fff}
  .card{background:var(--card);padding:14px;border-radius:10px;margin-top:12px;box-shadow:0 2px 10px var(--shadow)}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type=text], input[type=number], select{width:100%;padding:10px;border-radius:8px;border:1px solid #dfeee0}
  .row{display:flex;gap:12px}
  .row .col{flex:1}
  button{background:var(--primary);color:#fff;border:0;padding:10px 12px;border-radius:8px;cursor:pointer}
  .btn-ghost{background:transparent;border:1px solid #dfeee0;color:var(--muted);padding:8px 10px;border-radius:8px}
  .btn-danger{background:var(--danger)}
  .expenses{display:grid;gap:10px;margin-top:8px}
  .expense{display:flex;gap:10px;align-items:center;padding:10px;border-radius:8px;background:#fff;border:1px solid #eef6ee}
  .avatar{width:44px;height:44px;border-radius:999px;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px}
  pre{white-space:pre-wrap;background:#f7faf7;padding:10px;border-radius:8px;border:1px solid #e8f4e8}
  .subtabs{display:flex;gap:6px}
  .subtab{padding:6px 10px;border-radius:8px;background:#f2f5f2;border:1px solid #e8efe8;cursor:pointer}
  .subtab.active{background:var(--primary);color:#fff}
  .filters{display:flex;gap:6px}
  .filters button{padding:6px 8px;font-size:13px;border-radius:8px}
  .graph-row{display:flex;align-items:center;gap:10px;margin-bottom:6px}
  .bar{height:18px;border-radius:6px;background:var(--primary);transition:width .4s}

  /* hamburger for mobile */
  .hamburger{display:none;width:42px;height:42px;border-radius:8px;border:1px solid #e6efe6;background:transparent;align-items:center;justify-content:center;cursor:pointer}
  @media(max-width:800px){
    .menu{display:none;flex-direction:column}
    .hamburger{display:flex}
    .row{flex-direction:column}
  }

  /* modal */
  .modal-back{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;z-index:80}
  .modal{background:#fff;padding:16px;border-radius:10px;max-width:420px;width:94%}
  .modal h3{margin:0 0 8px 0}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        <h1>RoomExpense Pro</h1>
        <div class="small">shared room expenses — mobile & desktop</div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button class="hamburger" id="hamburger" title="Menu">
          <svg width="20" height="14" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M3 12h18M3 18h18" stroke="#4b6b5a" stroke-width="1.4" stroke-linecap="round"/></svg>
        </button>

        <div class="nav-actions">
          <div id="profile-icon" class="icon-btn" title="Login as roommate">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 12a5 5 0 100-10 5 5 0 000 10zM3 21a9 9 0 0118 0" stroke="#4b6b5a" stroke-width="1.1" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </div>
          <div id="admin-icon" class="icon-btn" title="Admin">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 2l3 6 6 .5-4.5 3.5L18 20l-6-4-6 4 .5-8.5L2 8.5 8 8 12 2z" stroke="#4b6b5a" stroke-width="0.9" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </div>
        </div>
      </div>
    </header>

    <div class="menu" id="main-menu">
      <div class="menu-item active" data-section="add">Add Expense</div>
      <div class="menu-item" data-section="summary">Live Summary</div>
      <div class="menu-item" data-section="history">History</div>
      <div class="menu-item" data-section="analysis">Analysis</div>
      <div class="menu-item" data-section="settings">Settings</div>
    </div>

    <!-- ADD -->
    <div id="section-add" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Record Purchase</div>
        <div class="small">Date captured automatically</div>
      </div>

      <div style="margin-top:10px">
        <div class="row">
          <div class="col">
            <label>Payer (who paid)</label>
            <select id="payer-select"></select>
          </div>
          <div class="col">
            <label>Split between (tick who share)</label>
            <div id="split-list" style="display:flex;flex-wrap:wrap;gap:8px"></div>
            <div class="small" style="margin-top:6px">Only selected people will share the cost.</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="col">
            <label>Item name</label>
            <input id="item-name" type="text" placeholder="e.g. Rice, Milk">
          </div>
          <div class="col">
            <label>Category</label>
            <select id="item-category">
              <option>Grocery</option>
              <option>Dmart</option>
              <option>Rent</option>
              <option>Electricity</option>
              <option>Bills</option>
              <option>Other</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px;align-items:end">
          <div class="col">
            <label>Amount (₹)</label>
            <input id="item-amount" type="number" min="0" step="1" placeholder="100">
          </div>
          <div style="width:220px">
            <label>&nbsp;</label>
            <div style="display:flex;gap:8px">
              <button id="save-expense">Save</button>
              <button id="save-view" class="btn-ghost">Save & View</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SUMMARY -->
    <div id="section-summary" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Live Summary & Balances</div>
        <div class="small">Cycle uses expenses after last settlement</div>
      </div>

      <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div style="padding:12px;background:#fff;border-radius:8px;border:1px solid #eef6ee">
          <div class="small">Total Spent (cycle)</div>
          <div id="total-spent" style="font-weight:700;margin-top:6px">₹0</div>
        </div>
        <div style="padding:12px;background:#fff;border-radius:8px;border:1px solid #eef6ee">
          <div class="small">Per Person (cycle)</div>
          <div id="per-person" style="font-weight:700;margin-top:6px">₹0</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div style="font-weight:700">Balances</div>
        <div id="balances" style="margin-top:8px"></div>
      </div>

      <div style="margin-top:12px">
        <div style="font-weight:700">Settlement Suggestion</div>
        <pre id="settlement-suggestion">No expenses yet.</pre>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="mark-settled">Mark All Settled</button>
          <button id="preview-settlement" class="btn-ghost">Preview</button>
        </div>
      </div>
    </div>

    <!-- HISTORY -->
    <div id="section-history" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700">History</div>
          <div class="small">Expenses • Settlements • Deleted</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="subtabs" id="history-subtabs">
            <div class="subtab active" data-tab="expenses">Expenses</div>
            <div class="subtab" data-tab="settlements">Settlements</div>
            <div class="subtab" data-tab="deleted">Deleted</div>
          </div>
          <div class="filters">
            <button class="btn-ghost active" data-filter="day">Day</button>
            <button class="btn-ghost" data-filter="week">Week</button>
            <button class="btn-ghost" data-filter="month">Month</button>
          </div>
        </div>
      </div>

      <div id="history-list" style="margin-top:12px"></div>
    </div>

    <!-- ANALYSIS -->
    <div id="section-analysis" class="card" style="display:none">
      <div style="font-weight:700">Analysis — Month-wise totals</div>
      <div class="small" style="margin-top:6px">All expenses included (settlements do not remove data)</div>
      <div id="analysis-graph" style="margin-top:12px"></div>
      <div style="margin-top:12px">
        <div style="font-weight:700">Settlement History</div>
        <div id="analysis-settlements" class="small" style="margin-top:6px">No settlements yet.</div>
      </div>
    </div>

    <!-- SETTINGS -->
    <div id="section-settings" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Settings</div>
        <div class="small">Admin-only actions appear when admin is logged in</div>
      </div>

      <div style="margin-top:10px">
        <div style="font-weight:700">Roommate Login</div>
        <div class="small" style="margin-top:6px">Click profile icon to login as Tejesh, Vishal, Abhishek, Ujwal, Bhargav (password name@123)</div>
      </div>

      <div style="margin-top:12px" class="card">
        <div style="font-weight:700">Admin Controls</div>
        <div class="small" style="margin-top:6px">Admin ID: <b>admin</b> | Password: <b>admin@123</b></div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <input id="admin-id" type="text" placeholder="admin">
          <input id="admin-pass" type="password" placeholder="admin@123">
          <button id="admin-login" class="btn-ghost">Admin Login</button>
          <button id="admin-logout" class="btn-ghost" style="display:none">Logout</button>
        </div>
        <div style="margin-top:8px" class="small">Admin status: <span id="admin-status">Not logged in</span></div>
      </div>

      <div style="margin-top:12px" class="card">
        <div style="font-weight:700">Data / Admin Utilities</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="export-json" class="btn-ghost">Export JSON</button>
          <button id="import-json" class="btn-ghost">Import JSON</button>
          <input id="json-file" type="file" accept="application/json" style="display:none">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="reset-expenses" class="btn-ghost">Reset Expenses</button>
          <button id="clear-all" class="btn-danger">Clear All Data</button>
        </div>
      </div>
    </div>

    <div style="height:20px"></div>
    <div class="small" style="text-align:center;color:var(--muted)">Data stored locally in your browser (localStorage). Later we can add Firebase sync.</div>
  </div>

  <!-- Roommate login modal -->
  <div id="modal-room" class="modal-back" aria-hidden>
    <div class="modal">
      <h3>Roommate Login</h3>
      <div class="small">Enter your name (Tejesh, Vishal, Abhishek, Ujwal, Bhargav) and password (name@123)</div>
      <div style="margin-top:10px">
        <label>Name</label>
        <input id="room-name" type="text" placeholder="Tejesh">
        <label style="margin-top:8px">Password</label>
        <input id="room-pass" type="password" placeholder="Tejesh@123">
        <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
          <button id="room-login" class="btn-ghost">Login</button>
          <button id="room-close" class="btn-ghost">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin modal (used on smaller screens) -->
  <div id="modal-admin" class="modal-back" aria-hidden>
    <div class="modal">
      <h3>Admin Login</h3>
      <div class="small">Admin ID: admin | Password: admin@123</div>
      <div style="margin-top:10px">
        <label>Admin ID</label>
        <input id="modal-admin-id" type="text" placeholder="admin">
        <label style="margin-top:8px">Password</label>
        <input id="modal-admin-pass" type="password" placeholder="admin@123">
        <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
          <button id="modal-admin-login" class="btn-ghost">Login</button>
          <button id="modal-admin-close" class="btn-ghost">Close</button>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  'use strict';

  const KEY = 'roomexpense_final_v3';
  const DEFAULT_ROOMMATES = ['Tejesh','Vishal','Abhishek','Ujwal','Bhargav'];

  function todayISO(){ return new Date().toISOString().slice(0,10); }
  function uid(pref){ return pref + '_' + Date.now() + '_' + Math.floor(Math.random()*1000); }

  // load/save
  function loadState(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return {roommates: DEFAULT_ROOMMATES.slice(), expenses: [], settlements: [], deleted: [], currentUser: null, adminLogged: false};
      const s = JSON.parse(raw);
      s.roommates = s.roommates || DEFAULT_ROOMMATES.slice();
      s.expenses = s.expenses || [];
      s.settlements = s.settlements || [];
      s.deleted = s.deleted || [];
      s.currentUser = s.currentUser || null;
      s.adminLogged = !!s.adminLogged;
      return s;
    } catch(e){ console.error(e); return {roommates: DEFAULT_ROOMMATES.slice(), expenses: [], settlements: [], deleted: [], currentUser: null, adminLogged: false}; }
  }
  function saveState(s){ localStorage.setItem(KEY, JSON.stringify(s)); }

  // flash
  function flash(msg, t=1400){
    let el = document.getElementById('__flash');
    if(!el){ el = document.createElement('div'); el.id='__flash'; el.style.position='fixed'; el.style.right='16px'; el.style.bottom='16px'; el.style.zIndex=200; el.style.background='rgba(0,0,0,0.75)'; el.style.color='#fff'; el.style.padding='8px 12px'; el.style.borderRadius='8px'; document.body.appendChild(el); }
    el.textContent = msg; el.style.opacity = '1';
    setTimeout(()=> el.style.opacity = '0', t);
  }

  // state
  let state = loadState();

  // DOM refs
  const sections = {
    add: document.getElementById('section-add'),
    summary: document.getElementById('section-summary'),
    history: document.getElementById('section-history'),
    analysis: document.getElementById('section-analysis'),
    settings: document.getElementById('section-settings')
  };
  const menuItems = document.querySelectorAll('.menu-item');
  const hamburger = document.getElementById('hamburger');

  // add refs
  const payerSelect = document.getElementById('payer-select');
  const splitList = document.getElementById('split-list');
  const itemName = document.getElementById('item-name');
  const itemCategory = document.getElementById('item-category');
  const itemAmount = document.getElementById('item-amount');
  const saveExpenseBtn = document.getElementById('save-expense');
  const saveViewBtn = document.getElementById('save-view');

  // summary refs
  const totalSpentEl = document.getElementById('total-spent');
  const perPersonEl = document.getElementById('per-person');
  const balancesEl = document.getElementById('balances');
  const settlementSuggestionEl = document.getElementById('settlement-suggestion');
  const markSettledBtn = document.getElementById('mark-settled');
  const previewSettlementBtn = document.getElementById('preview-settlement');

  // history refs
  const historyList = document.getElementById('history-list');
  const historySubtabs = document.querySelectorAll('#history-subtabs .subtab');
  const historyFilters = document.querySelectorAll('.filters button');

  // analysis refs
  const analysisGraph = document.getElementById('analysis-graph');
  const analysisSettlements = document.getElementById('analysis-settlements');

  // settings/admin refs
  const roommateListEl = document.getElementById('roommate-list');
  const newRmInput = document.getElementById('new-roommate');
  const addRmBtn = document.getElementById('add-roommate');
  const adminIdInput = document.getElementById('admin-id');
  const adminPassInput = document.getElementById('admin-pass');
  const adminLoginBtn = document.getElementById('admin-login');
  const adminLogoutBtn = document.getElementById('admin-logout');
  const adminStatus = document.getElementById('admin-status');

  const profileIcon = document.getElementById('profile-icon');
  const adminIcon = document.getElementById('admin-icon');

  // modals
  const modalRoom = document.getElementById('modal-room');
  const roomName = document.getElementById('room-name');
  const roomPass = document.getElementById('room-pass');
  const roomLoginBtn = document.getElementById('room-login');
  const roomCloseBtn = document.getElementById('room-close');

  const modalAdmin = document.getElementById('modal-admin');
  const modalAdminId = document.getElementById('modal-admin-id');
  const modalAdminPass = document.getElementById('modal-admin-pass');
  const modalAdminLogin = document.getElementById('modal-admin-login');
  const modalAdminClose = document.getElementById('modal-admin-close');

  // data utils
  const exportBtn = document.getElementById('export-json');
  const importBtn = document.getElementById('import-json');
  const jsonFileInput = document.getElementById('json-file');
  const resetExpensesBtn = document.getElementById('reset-expenses');
  const clearAllBtn = document.getElementById('clear-all');

  // navigation
  function switchSection(id){
    Object.keys(sections).forEach(k => sections[k].style.display = (k===id? 'block':'none'));
    menuItems.forEach(mi => mi.classList.toggle('active', mi.getAttribute('data-section')===id));
    if(id==='summary') calculateAndRender();
    if(id==='history') renderHistory();
    if(id==='analysis') renderAnalysis();
    if(window.innerWidth <= 800) document.getElementById('main-menu').style.display = 'none';
  }
  menuItems.forEach(mi => mi.addEventListener('click', ()=> switchSection(mi.getAttribute('data-section'))));
  hamburger.addEventListener('click', ()=> {
    const m = document.getElementById('main-menu');
    m.style.display = (m.style.display === 'flex' ? 'none' : 'flex');
  });
  switchSection('add');

  // render roommate controls
  function renderRoommatesUI(){
    payerSelect.innerHTML = '';
    state.roommates.forEach(name => {
      const opt = document.createElement('option'); opt.value = name; opt.textContent = name; payerSelect.appendChild(opt);
    });
    splitList.innerHTML = '';
    state.roommates.forEach(name => {
      const id = 'split_' + name.replace(/\s+/g,'_') + '_' + Math.floor(Math.random()*1000);
      const lbl = document.createElement('label'); lbl.style.display='inline-flex'; lbl.style.alignItems='center'; lbl.style.gap='6px';
      const chk = document.createElement('input'); chk.type='checkbox'; chk.value = name; chk.id = id; chk.checked = true;
      const span = document.createElement('span'); span.className='small'; span.textContent = name;
      lbl.appendChild(chk); lbl.appendChild(span); splitList.appendChild(lbl);
    });
    if(state.currentUser && state.roommates.includes(state.currentUser)) payerSelect.value = state.currentUser;
    renderRoommateList();
  }

  function renderRoommateList(){
    roommateListEl.innerHTML = '';
    state.roommates.forEach(name => {
      const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='6px 0';
      const left = document.createElement('div'); left.textContent = name; left.className='small';
      const right = document.createElement('div');
      const rmBtn = document.createElement('button'); rmBtn.textContent='Remove'; rmBtn.className='btn-ghost';
      rmBtn.addEventListener('click', ()=> {
        if(!state.adminLogged) return alert('Admin only');
        if(!confirm('Remove ' + name + ' and their expenses?')) return;
        const removed = state.expenses.filter(e => e.payer === name);
        removed.forEach(e => state.deleted.push({type:'expense', data:e, deletedBy:'admin', deletedAt: todayISO()}));
        state.expenses = state.expenses.filter(e => e.payer !== name);
        state.roommates = state.roommates.filter(r => r !== name);
        saveState(state); renderRoommatesUI(); calculateAndRender(); renderHistory(); renderAnalysis(); flash('Removed ' + name);
      });
      right.appendChild(rmBtn);
      row.appendChild(left); row.appendChild(right); roommateListEl.appendChild(row);
    });
    addRmBtn.onclick = ()=> {
      if(!state.adminLogged) return alert('Admin only');
      const name = (newRmInput.value||'').trim();
      if(!name) return alert('Enter name');
      if(state.roommates.some(r => r.toLowerCase() === name.toLowerCase())) return alert('Name exists');
      state.roommates.push(name); saveState(state); newRmInput.value=''; renderRoommatesUI(); flash('Added ' + name);
    };
  }

  // login / logout (roommate)
  profileIcon.addEventListener('click', ()=> {
    modalRoom.style.display = 'flex'; roomName.value = ''; roomPass.value = '';
    roomName.focus();
  });
  roomCloseBtn.addEventListener('click', ()=> modalRoom.style.display = 'none');
  roomLoginBtn.addEventListener('click', ()=> {
    const name = (roomName.value||'').trim();
    const pass = (roomPass.value||'').trim();
    if(!name) return alert('Enter name');
    if(pass !== (name + '@123')) return alert('Invalid password');
    const actual = state.roommates.find(r => r.toLowerCase() === name.toLowerCase());
    if(!actual) return alert('Unknown user');
    state.currentUser = actual; saveState(state); modalRoom.style.display = 'none'; renderRoommatesUI(); calculateAndRender(); flash('Logged in: ' + state.currentUser);
  });

  // admin modal
  adminIcon.addEventListener('click', ()=> {
    if(state.adminLogged){
      if(confirm('Admin logged in — logout?')){ state.adminLogged = false; saveState(state); updateAdminUI(); flash('Admin logged out'); }
      return;
    }
    modalAdmin.style.display = 'flex'; modalAdminId.value=''; modalAdminPass.value=''; modalAdminId.focus();
  });
  modalAdminClose.addEventListener('click', ()=> modalAdmin.style.display = 'none');
  modalAdminLogin.addEventListener('click', ()=> {
    const id = (modalAdminId.value||'').trim(); const pass = (modalAdminPass.value||'').trim();
    if(id !== 'admin' || pass !== 'admin@123') return alert('Invalid admin credentials');
    state.adminLogged = true; saveState(state); modalAdmin.style.display='none'; updateAdminUI(); flash('Admin logged in');
  });

  // admin small form in settings
  adminLoginBtn.addEventListener('click', ()=> {
    const id = (adminIdInput.value||'').trim(); const pass = (adminPassInput.value||'').trim();
    if(id !== 'admin' || pass !== 'admin@123') return alert('Invalid admin credentials');
    state.adminLogged = true; saveState(state); updateAdminUI(); flash('Admin logged in');
  });
  adminLogoutBtn.addEventListener('click', ()=> { state.adminLogged = false; saveState(state); updateAdminUI(); flash('Admin logged out'); });

  function updateAdminUI(){
    const icon = document.getElementById('admin-icon');
    const status = document.getElementById('admin-status');
    if(state.adminLogged){ icon.classList.add('active'); status.textContent = 'Admin (logged in)'; adminLogoutBtn.style.display = 'inline-block'; }
    else { icon.classList.remove('active'); status.textContent = 'Not logged in'; adminLogoutBtn.style.display = 'none'; }
  }

  // add expense
  function getSplitSelected(){
    const chks = splitList.querySelectorAll('input[type=checkbox]');
    const arr = [];
    chks.forEach(c => { if(c.checked) arr.push(c.value); });
    return arr;
  }

  saveExpenseBtn.addEventListener('click', ()=>{
    const payer = payerSelect.value;
    const item = (itemName.value||'').trim();
    const category = itemCategory.value || 'Other';
    const amount = Number(itemAmount.value);
    const splitBetween = getSplitSelected();
    if(!payer || !item || !amount || isNaN(amount) || amount<=0) return alert('Fill payer, item and positive amount');
    if(!splitBetween.length) return alert('Select at least one person to split with (including yourself if applicable)');
    const exp = { id: uid('e'), payer, item, category, amount: Number(amount), date: todayISO(), splitBetween };
    state.expenses.push(exp); saveState(state);
    itemName.value=''; itemAmount.value=''; renderRoommatesUI(); calculateAndRender(); renderHistory(); renderAnalysis(); flash('Expense saved');
  });

  saveViewBtn.addEventListener('click', ()=> { saveExpenseBtn.click(); switchSection('summary'); });

  // history tabs/filters
  let historyTab = 'expenses';
  let historyFilter = 'day';
  historySubtabs.forEach(st => st.addEventListener('click', ()=> {
    historySubtabs.forEach(x => x.classList.remove('active')); st.classList.add('active'); historyTab = st.getAttribute('data-tab'); renderHistory();
  }));
  historyFilters.forEach(f => f.addEventListener('click', ()=> {
    historyFilters.forEach(x => x.classList.remove('active')); f.classList.add('active'); historyFilter = f.getAttribute('data-filter'); renderHistory();
  }));

  // date helpers
  function isSameDay(a,b){ return a.toDateString() === b.toDateString(); }
  function isSameWeek(a,b){ function sow(d){ const date=new Date(d); const day=date.getDay(); const diff = date.getDate() - day + (day===0?-6:1); date.setDate(diff); date.setHours(0,0,0,0); return date.getTime(); } return sow(a) === sow(b); }
  function isSameMonth(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth(); }

  function filterByPeriod(arr, period, key='date'){
    const today = new Date();
    if(period === 'day') return arr.filter(i => isSameDay(new Date(i[key]), today));
    if(period === 'week') return arr.filter(i => isSameWeek(new Date(i[key]), today));
    if(period === 'month') return arr.filter(i => isSameMonth(new Date(i[key]), today));
    return arr;
  }

  // render history
  function renderHistory(){
    historyList.innerHTML = '';
    if(historyTab === 'expenses'){
      const list = filterByPeriod(state.expenses, historyFilter, 'date');
      if(!list.length) return historyList.innerHTML = '<div class="small">No expenses found.</div>';
      const cont = document.createElement('div'); cont.className='expenses';
      list.slice().reverse().forEach(exp => {
        const row = document.createElement('div'); row.className='expense';
        const av = document.createElement('div'); av.className='avatar'; av.textContent = (exp.payer||'?')[0];
        const meta = document.createElement('div'); meta.style.flex='1';
        const title = document.createElement('div'); title.style.fontWeight='700'; title.textContent = exp.item + ' — ₹' + Number(exp.amount).toFixed(2) + ' (' + (exp.category||'') + ')';
        const sub = document.createElement('div'); sub.className='small'; sub.textContent = exp.payer + ' • ' + exp.date + ' • split: ' + (exp.splitBetween? exp.splitBetween.join(', '):'—');
        meta.appendChild(title); meta.appendChild(sub);
        const controls = document.createElement('div');
        const del = document.createElement('button'); del.className='btn-ghost'; del.textContent='Delete';
        del.addEventListener('click', ()=> {
          if(!state.adminLogged) return alert('Admin only');
          if(!confirm('Delete this expense?')) return;
          const idx = state.expenses.findIndex(x=> x.id === exp.id);
          if(idx!==-1){ const removed = state.expenses.splice(idx,1)[0]; state.deleted.push({type:'expense', data:removed, deletedBy:'admin', deletedAt: todayISO()}); saveState(state); renderHistory(); calculateAndRender(); renderAnalysis(); flash('Deleted'); }
        });
        controls.appendChild(del);
        row.appendChild(av); row.appendChild(meta); row.appendChild(controls); cont.appendChild(row);
      });
      historyList.appendChild(cont);
    } else if(historyTab === 'settlements'){
      const list = filterByPeriod(state.settlements, historyFilter, 'date');
      if(!list.length) return historyList.innerHTML = '<div class="small">No settlements.</div>';
      const cont = document.createElement('div'); cont.className='expenses';
      list.slice().reverse().forEach(s => {
        const row = document.createElement('div'); row.className='expense';
        const av = document.createElement('div'); av.className='avatar'; av.textContent='S';
        const meta = document.createElement('div'); meta.style.flex='1';
        const title = document.createElement('div'); title.style.fontWeight='700'; title.textContent = 'Settlement — ₹' + Number(s.total).toFixed(2);
        const sub = document.createElement('div'); sub.className='small'; sub.textContent = s.date + ' • ' + (s.participants||[]).join(', ');
        meta.appendChild(title); meta.appendChild(sub);
        const controls = document.createElement('div');
        const view = document.createElement('button'); view.className='btn-ghost'; view.textContent='View';
        view.addEventListener('click', ()=> alert((s.instructions||[]).join('\n') || 'No details'));
        const del = document.createElement('button'); del.className='btn-ghost'; del.textContent='Delete';
        del.addEventListener('click', ()=> {
          if(!state.adminLogged) return alert('Admin only');
          if(!confirm('Delete this settlement?')) return;
          const idx = state.settlements.findIndex(x => x.id === s.id);
          if(idx!==-1){ const rem = state.settlements.splice(idx,1)[0]; state.deleted.push({type:'settlement', data:rem, deletedBy:'admin', deletedAt: todayISO()}); saveState(state); renderHistory(); renderAnalysis(); flash('Deleted settlement'); }
        });
        controls.appendChild(view); controls.appendChild(del);
        row.appendChild(av); row.appendChild(meta); row.appendChild(controls); cont.appendChild(row);
      });
      historyList.appendChild(cont);
    } else {
      const list = filterByPeriod(state.deleted, historyFilter, 'deletedAt');
      if(!list.length) return historyList.innerHTML = '<div class="small">No deleted records.</div>';
      const cont = document.createElement('div'); cont.className='expenses';
      list.slice().reverse().forEach(d => {
        const row = document.createElement('div'); row.className='expense';
        const av = document.createElement('div'); av.className='avatar'; av.textContent = d.type==='expense'? 'E':'S';
        const meta = document.createElement('div'); meta.style.flex='1';
        const title = document.createElement('div'); title.style.fontWeight='700';
        title.textContent = d.type==='expense' ? (d.data.item + ' — ₹' + Number(d.data.amount).toFixed(2)) : ('Settlement — ₹' + Number(d.data.total).toFixed(2));
        const sub = document.createElement('div'); sub.className='small'; sub.textContent = d.deletedAt + ' • deleted by: ' + (d.deletedBy || 'admin');
        meta.appendChild(title); meta.appendChild(sub);
        const controls = document.createElement('div');
        const restore = document.createElement('button'); restore.className='btn-ghost'; restore.textContent='Restore';
        restore.addEventListener('click', ()=> {
          if(!state.adminLogged) return alert('Admin only');
          if(!confirm('Restore this record?')) return;
          if(d.type==='expense'){ state.expenses.push(d.data); } else if(d.type==='settlement'){ state.settlements.push(d.data); }
          const idx = state.deleted.findIndex(x => x === d); if(idx!==-1) state.deleted.splice(idx,1);
          saveState(state); renderHistory(); calculateAndRender(); renderAnalysis(); flash('Restored');
        });
        controls.appendChild(restore);
        row.appendChild(av); row.appendChild(meta); row.appendChild(controls); cont.appendChild(row);
      });
      historyList.appendChild(cont);
    }
  }

  // analysis
  function getMonthYear(dateString){ const d = new Date(dateString); return d.toLocaleString('en-US',{month:'short'}) + ' ' + d.getFullYear(); }
  function renderAnalysis(){
    analysisGraph.innerHTML = '';
    if(!state.expenses.length){ analysisGraph.textContent = 'No expense data.'; analysisSettlements.textContent = 'No settlements yet.'; return; }
    const totals = state.expenses.reduce((acc,e)=> { const m = getMonthYear(e.date); acc[m] = (acc[m]||0) + Number(e.amount); return acc; }, {});
    const rows = Object.keys(totals).map(k=>({month:k, total:totals[k]}));
    rows.sort((a,b)=> new Date(a.month.replace(' ',' 1, ')) - new Date(b.month.replace(' ',' 1, ')));
    const recent = rows.slice(-12); const max = Math.max(1, ...recent.map(r=>r.total));
    recent.forEach(r => {
      const div = document.createElement('div'); div.className='graph-row';
      const label = document.createElement('div'); label.style.width='120px'; label.className='small'; label.textContent = r.month;
      const barWrap = document.createElement('div'); barWrap.style.flex='1';
      const bar = document.createElement('div'); bar.className='bar'; bar.style.width = (Math.max(6, (r.total/max)*100)) + '%';
      barWrap.appendChild(bar);
      const val = document.createElement('div'); val.style.width='90px'; val.className='small'; val.textContent = '₹' + Math.round(r.total);
      div.appendChild(label); div.appendChild(barWrap); div.appendChild(val); analysisGraph.appendChild(div);
    });
    analysisSettlements.innerHTML = state.settlements.length ? state.settlements.slice().reverse().map(s=> s.date + ' • ₹' + Math.round(s.total)).join('<br>') : 'No settlements yet.';
  }

  // settlement / live summary logic
  function calculateAndRender(){
    // last settlement date (if any)
    let lastSet = null;
    if(state.settlements.length) lastSet = state.settlements.reduce((acc,s) => acc > s.date ? acc : s.date, state.settlements[0].date);
    const relevant = state.expenses.filter(e => !lastSet || (new Date(e.date) > new Date(lastSet)));
    // compute total spent in cycle
    const total = relevant.reduce((s,e)=> s + Number(e.amount), 0);
    const n = Math.max(1, state.roommates.length);
    const perPerson = total / n;
    totalSpentEl.textContent = '₹' + total.toFixed(2);
    perPersonEl.textContent = '₹' + perPerson.toFixed(2);

    // compute each person's net: net = amount paid - sum(shares of expenses where they are in split)
    const paid = {}; const share = {};
    state.roommates.forEach(r => { paid[r]=0; share[r]=0; });
    relevant.forEach(e => {
      paid[e.payer] = (paid[e.payer]||0) + Number(e.amount);
      const participants = Array.isArray(e.splitBetween) && e.splitBetween.length ? e.splitBetween : state.roommates;
      const per = Number(e.amount) / participants.length;
      participants.forEach(p => { share[p] = (share[p]||0) + per; });
    });
    const balanceArr = [];
    state.roommates.forEach(r => {
      const net = +( (paid[r]||0) - (share[r]||0) ).toFixed(2);
      balanceArr.push({ name: r, paid: +(paid[r]||0), share: +(share[r]||0), net });
    });

    // render balances UI
    balancesEl.innerHTML = '';
    balanceArr.forEach(b => {
      const p = document.createElement('div'); p.style.display='flex'; p.style.justifyContent='space-between'; p.style.alignItems='center';
      p.style.padding='8px'; p.style.background='#fff'; p.style.border='1px solid #eef6ee'; p.style.borderRadius='8px';
      const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='10px';
      const av = document.createElement('div'); av.className='avatar'; av.textContent = (b.name && b.name[0])? b.name[0] : '?';
      const txt = document.createElement('div'); const nm = document.createElement('div'); nm.style.fontWeight='700'; nm.textContent = b.name;
      const sub = document.createElement('div'); sub.className='small'; sub.textContent = 'Paid: ₹' + b.paid.toFixed(2) + ' • Share: ₹' + b.share.toFixed(2);
      txt.appendChild(nm); txt.appendChild(sub); left.appendChild(av); left.appendChild(txt);
      const right = document.createElement('div'); right.style.fontWeight='700';
      right.textContent = (b.net > 0)? ('To Receive ₹' + b.net.toFixed(2)) : ('Owes ₹' + Math.abs(b.net).toFixed(2));
      p.appendChild(left); p.appendChild(right); balancesEl.appendChild(p);
    });

    // settlement instructions using net balances
    const instructions = generateInstructions(balanceArr);
    settlementSuggestionEl.textContent = instructions.length ? instructions.join('\n') : 'All settled or no expenses.';
  }

  // generate settlement instructions from net balances
  function generateInstructions(balanceArr){
    const creditors = balanceArr.filter(x=> x.net > 0).map(x=>({...x})).sort((a,b)=> b.net - a.net);
    const debtors = balanceArr.filter(x=> x.net < 0).map(x=>({...x})).sort((a,b)=> a.net - b.net);
    const res = []; let i=0,j=0;
    while(i<debtors.length && j<creditors.length){
      const d = debtors[i], c = creditors[j];
      const amt = Math.min(Math.abs(d.net), c.net);
      if(amt > 0.01){ res.push(d.name + ' pays ₹' + amt.toFixed(2) + ' → ' + c.name); d.net += amt; c.net -= amt; }
      if(Math.abs(d.net) < 0.01) i++;
      if(c.net < 0.01) j++;
    }
    return res;
  }

  // mark settled — allowed by any logged-in roommate
  markSettledBtn.addEventListener('click', ()=> {
    if(!state.currentUser) return alert('Login required to mark settlement');
    let lastSet = null;
    if(state.settlements.length) lastSet = state.settlements.reduce((acc,s) => acc > s.date ? acc : s.date, state.settlements[0].date);
    const relevant = state.expenses.filter(e => !lastSet || (new Date(e.date) > new Date(lastSet)));
    const total = relevant.reduce((s,e)=> s + Number(e.amount), 0);
    if(total === 0) return alert('No expenses to settle');
    // compute participant list and instructions like above
    const n = Math.max(1, state.roommates.length);
    const paid = {}; const share = {};
    state.roommates.forEach(r=> { paid[r]=0; share[r]=0; });
    relevant.forEach(e => {
      paid[e.payer] = (paid[e.payer]||0) + Number(e.amount);
      const participants = Array.isArray(e.splitBetween) && e.splitBetween.length ? e.splitBetween : state.roommates;
      const per = Number(e.amount) / participants.length;
      participants.forEach(p => { share[p] = (share[p]||0) + per; });
    });
    const balanceArr = state.roommates.map(r => ({ name:r, paid: +(paid[r]||0), share: +(share[r]||0), net: +(((paid[r]||0) - (share[r]||0)).toFixed(2)) }));
    const instructions = generateInstructions(balanceArr);
    const participants = balanceArr.filter(b=> Math.abs(b.paid) > 0 || Math.abs(b.share) > 0).map(b=>b.name);
    const settlement = { id: uid('s'), date: todayISO(), total: total, perPerson: +(total / Math.max(1, state.roommates.length)).toFixed(2), participants, instructions };
    state.settlements.push(settlement); saveState(state); calculateAndRender(); renderHistory(); renderAnalysis(); flash('Settlement recorded');
  });

  previewSettlementBtn.addEventListener('click', ()=> alert(settlementSuggestionEl.textContent || 'No suggestion'));

  // export/import/reset/clear (admin-only)
  exportBtn.addEventListener('click', ()=> {
    if(!state.adminLogged) return alert('Admin only');
    const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'roomexpense_export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });
  importBtn.addEventListener('click', ()=> { if(!state.adminLogged) return alert('Admin only'); jsonFileInput.click(); });
  jsonFileInput.addEventListener('change', (ev)=> {
    if(!state.adminLogged) return alert('Admin only');
    const f = ev.target.files[0]; if(!f) return;
    const r = new FileReader(); r.onload = function(){ try{ const parsed = JSON.parse(r.result); if(parsed.roommates && parsed.expenses && parsed.settlements){ state = parsed; state.deleted = state.deleted || []; state.currentUser = state.currentUser || null; state.adminLogged = !!state.adminLogged; saveState(state); initAll(); alert('Imported OK'); } else alert('Invalid file'); } catch(e){ alert('Invalid JSON'); } }; r.readAsText(f);
  });

  resetExpensesBtn.addEventListener('click', ()=> {
    if(!state.adminLogged) return alert('Admin only');
    if(!confirm('Remove all expenses? (roommates remain)')) return;
    state.expenses.forEach(e => state.deleted.push({type:'expense', data:e, deletedBy:'admin', deletedAt: todayISO()}));
    state.expenses = []; saveState(state); calculateAndRender(); renderHistory(); renderAnalysis(); flash('Expenses reset');
  });

  clearAllBtn.addEventListener('click', ()=> {
    if(!state.adminLogged) return alert('Admin only');
    if(!confirm('Clear ALL data? This cannot be undone.')) return;
    state = {roommates: DEFAULT_ROOMMATES.slice(), expenses: [], settlements: [], deleted: [], currentUser: null, adminLogged: false};
    saveState(state); initAll(); flash('Cleared all data');
  });

  // admin small form in settings
  adminLoginBtn.addEventListener('click', ()=> {
    const id = (adminIdInput.value||'').trim(); const pass = (adminPassInput.value||'').trim();
    if(id !== 'admin' || pass !== 'admin@123') return alert('Invalid admin credentials');
    state.adminLogged = true; saveState(state); updateAdminUI(); flash('Admin logged in');
  });
  adminLogoutBtn.addEventListener('click', ()=> { state.adminLogged = false; saveState(state); updateAdminUI(); flash('Admin logged out'); });

  // render initial UI
  function updateAdminUI(){
    if(state.adminLogged){ adminIcon.classList.add('active'); adminStatus.textContent = 'Admin (logged in)'; adminLogoutBtn.style.display='inline-block'; }
    else { adminIcon.classList.remove('active'); adminStatus.textContent = 'Not logged in'; adminLogoutBtn.style.display='none'; }
  }

  // initial rendering and boot
  function initAll(){
    if(!state.roommates || !state.roommates.length) state.roommates = DEFAULT_ROOMMATES.slice();
    saveState(state);
    renderRoommatesUI(); updateAdminUI(); calculateAndRender(); renderHistory(); renderAnalysis();
  }
  initAll();

  // save state on unload (defensive)
  window.addEventListener('beforeunload', ()=> saveState(state));
})();
</script>
</body>
</html>
        
